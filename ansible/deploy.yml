---
- hosts: all
  sudo: yes
  roles:
    - angstwad.docker_ubuntu
  vars:
    hostname: fountainhead-stat.us
    bind_port: 5000
  tasks:
    - name: db container
      docker:
        name: fountainheadstatus-db
        image: postgres
        state: started
        restart_policy: always
    - name: web container
      docker:
        name: fountainheadstatus-web
        image: dschep/fountainhead-status
        state: reloaded
        restart_policy: always
        pull: always
        ports:
          - "{{ bind_port }}:5000"
        links:
          - fountainheadstatus-db:db
        env:
          DB_URL: postgresql+psycopg2://postgres@db/
          ACCOUNT_SID: "{{ lookup('env', 'ACCOUNT_SID') }}"
          AUTH_TOKEN: "{{ lookup('env', 'AUTH_TOKEN') }}"
          FROM: "{{ lookup('env', 'FROM') }}"
          SERVER_URL: "{{ lookup('env', 'SERVER_URL') }}"
    - name: install nginx
      apt: pkg=nginx state=present
    - name: copy nginx site
      template: src=nginx-site dest=/etc/nginx/sites-enabled/fountainheadstatus
      notify:
        - restart nginx
    - name: create update script
      template: src=update-status dest=/usr/bin/update-fountainheadstatus
                mode=777
    - name: crontab to update status
      cron: name="update Fountainhead status" minute="0" hour="*/2"
            job="/usr/bin/update-fountainheadstatus"
  handlers:
    - name: restart nginx
      service: name=nginx state=restarted
